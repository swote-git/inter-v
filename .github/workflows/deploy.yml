name: Deploy InterV Application

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'README.md'
      - 'docs/**'

env:
  AWS_REGION: ap-northeast-2
  APPLICATION_NAME: interv

jobs:
  deploy-infrastructure:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: ~1.6.0
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Initialize Terraform
      run: |
        cd infrastructure/
        terraform init
    
    - name: Pre-deployment Resource Import
      env:
        TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
        TF_VAR_key_pair_name: ${{ secrets.EC2_KEY_PAIR_NAME }}
        TF_VAR_aws_region: ${{ env.AWS_REGION }}
        TF_VAR_app_name: ${{ env.APPLICATION_NAME }}
        TF_VAR_domain_name: "interv.swote.dev"
      run: |
        cd infrastructure/
        
        echo "ğŸ“¥ ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ Import ë° Route53 ë¬¸ì œ í•´ê²°..."
        
        # 1. í•µì‹¬ ë¦¬ì†ŒìŠ¤ë“¤ import (ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰)
        echo "ğŸ—ï¸ í•µì‹¬ ë¦¬ì†ŒìŠ¤ Import:"
        terraform import aws_db_subnet_group.main interv-db-subnet-group 2>/dev/null || echo "  âš ï¸ DB Subnet Group: ì´ë¯¸ ì¡´ì¬í•˜ê±°ë‚˜ Import ì‹¤íŒ¨"
        terraform import aws_iam_role.ec2_role interv-ec2-role 2>/dev/null || echo "  âš ï¸ IAM Role: ì´ë¯¸ ì¡´ì¬í•˜ê±°ë‚˜ Import ì‹¤íŒ¨"
        
        # ALB ê´€ë ¨
        ALB_ARN=$(aws elbv2 describe-load-balancers --names interv-alb --query 'LoadBalancers[0].LoadBalancerArn' --output text 2>/dev/null || echo "None")
        if [ "$ALB_ARN" != "None" ] && [ "$ALB_ARN" != "null" ]; then
          terraform import aws_lb.main "$ALB_ARN" 2>/dev/null || echo "  âš ï¸ ALB: ì´ë¯¸ ì¡´ì¬í•˜ê±°ë‚˜ Import ì‹¤íŒ¨"
        fi
        
        TG_ARN=$(aws elbv2 describe-target-groups --names interv-tg --query 'TargetGroups[0].TargetGroupArn' --output text 2>/dev/null || echo "None")
        if [ "$TG_ARN" != "None" ] && [ "$TG_ARN" != "null" ]; then
          terraform import aws_lb_target_group.app "$TG_ARN" 2>/dev/null || echo "  âš ï¸ Target Group: ì´ë¯¸ ì¡´ì¬í•˜ê±°ë‚˜ Import ì‹¤íŒ¨"
        fi
        
        # Auto Scaling Group
        terraform import aws_autoscaling_group.app interv-asg 2>/dev/null || echo "  âš ï¸ ASG: ì´ë¯¸ ì¡´ì¬í•˜ê±°ë‚˜ Import ì‹¤íŒ¨"
        
        # Launch Template
        LT_ID=$(aws ec2 describe-launch-templates --launch-template-names interv-lt --query 'LaunchTemplates[0].LaunchTemplateId' --output text 2>/dev/null || echo "None")
        if [ "$LT_ID" != "None" ] && [ "$LT_ID" != "null" ]; then
          terraform import aws_launch_template.app "$LT_ID" 2>/dev/null || echo "  âš ï¸ Launch Template: ì´ë¯¸ ì¡´ì¬í•˜ê±°ë‚˜ Import ì‹¤íŒ¨"
        fi
        
        # 2. Route53 ë ˆì½”ë“œ íŠ¹ë³„ ì²˜ë¦¬
        echo ""
        echo "ğŸŒ Route53 ë ˆì½”ë“œ ì²˜ë¦¬:"
        
        # Hosted Zone ID í™•ì¸
        HOSTED_ZONE_ID=$(aws route53 list-hosted-zones \
          --query "HostedZones[?Name=='swote.dev.'].Id" \
          --output text | cut -d'/' -f3 2>/dev/null || echo "")
        
        if [ -n "$HOSTED_ZONE_ID" ]; then
          echo "  ğŸ“ Hosted Zone ë°œê²¬: $HOSTED_ZONE_ID"
          
          # ê¸°ì¡´ A ë ˆì½”ë“œ í™•ì¸
          EXISTING_RECORD=$(aws route53 list-resource-record-sets \
            --hosted-zone-id "$HOSTED_ZONE_ID" \
            --query "ResourceRecordSets[?Name=='interv.swote.dev.' && Type=='A']" \
            --output json 2>/dev/null)
          
          if [ "$EXISTING_RECORD" != "[]" ] && [ -n "$EXISTING_RECORD" ]; then
            echo "  âœ… ê¸°ì¡´ A ë ˆì½”ë“œ ë°œê²¬ - Import ì‹œë„"
            
            # Route53 ë ˆì½”ë“œ import
            IMPORT_ID="${HOSTED_ZONE_ID}_interv.swote.dev_A"
            if terraform import aws_route53_record.main "$IMPORT_ID" 2>/dev/null; then
              echo "  ğŸ“¥ Route53 ë ˆì½”ë“œ Import ì„±ê³µ!"
            else
              echo "  âš ï¸ Route53 Import ì‹¤íŒ¨ - ìˆ˜ë™ìœ¼ë¡œ ë ˆì½”ë“œë¥¼ ì‚­ì œí•˜ê±°ë‚˜ ì¡°ê±´ë¶€ ìƒì„±ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤"
            fi
          else
            echo "  â„¹ï¸ ê¸°ì¡´ A ë ˆì½”ë“œ ì—†ìŒ - ìƒˆë¡œ ìƒì„±ë©ë‹ˆë‹¤"
          fi
        else
          echo "  âŒ Hosted Zoneì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
        fi
        
        echo ""
        echo "âœ… Import ê³¼ì • ì™„ë£Œ!"
    
    - name: Deploy Infrastructure
      env:
        TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
        TF_VAR_key_pair_name: ${{ secrets.EC2_KEY_PAIR_NAME }}
        TF_VAR_aws_region: ${{ env.AWS_REGION }}
        TF_VAR_app_name: ${{ env.APPLICATION_NAME }}
        TF_VAR_domain_name: "interv.swote.dev"
      run: |
        cd infrastructure/
        
        echo "ğŸ“‹ Terraform Plan ì‹¤í–‰..."
        if terraform plan -out=tfplan; then
          echo "âœ… Plan ì„±ê³µ!"
        else
          echo "âŒ Plan ì‹¤íŒ¨ - ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”"
          exit 1
        fi
        
        echo ""
        echo "ğŸš€ Infrastructure ë°°í¬ ì‹œì‘..."
        if terraform apply tfplan; then
          echo "âœ… ë°°í¬ ì„±ê³µ!"
        else
          echo "âŒ ë°°í¬ ì‹¤íŒ¨"
          exit 1
        fi
        
        echo "ğŸ“Š Output ì €ì¥..."
        terraform output -json > terraform-outputs.json
        
        # S3 ë²„í‚· ì´ë¦„ ì €ì¥
        S3_BUCKET=$(terraform output -raw s3_bucket_name 2>/dev/null || echo "")
        if [ -n "$S3_BUCKET" ]; then
          echo "S3_BUCKET_NAME=$S3_BUCKET" >> $GITHUB_ENV
          echo "ğŸª£ S3 Bucket: $S3_BUCKET"
        fi
        
        echo "ğŸ‰ Infrastructure ë°°í¬ ì™„ë£Œ!"
    
    outputs:
      s3_bucket_name: ${{ env.S3_BUCKET_NAME }}

  build-and-deploy:
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure]
    if: always() && !failure()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'corretto'
    
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: Build application
      run: |
        echo "ğŸ“¦ Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ..."
        
        if [ -d "inter-v" ]; then
          cd inter-v
          echo "Building in inter-v directory"
        elif [ -d "BE/inter-v" ]; then
          cd BE/inter-v
          echo "Building in BE/inter-v directory"
        else
          echo "âŒ Application directory not found!"
          exit 1
        fi
        
        mvn clean package -DskipTests
        
        JAR_FILE=$(find target -name "*.jar" | head -1)
        if [ -n "$JAR_FILE" ]; then
          echo "âœ… ë¹Œë“œ ì„±ê³µ: $JAR_FILE"
        else
          echo "âŒ ë¹Œë“œ ì‹¤íŒ¨: JAR íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          exit 1
        fi
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Deploy JAR and refresh instances
      run: |
        echo "ğŸš€ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ì‹œì‘..."
        
        # S3 ë²„í‚· ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
        cd infrastructure/
        terraform init
        S3_BUCKET=$(terraform output -raw s3_bucket_name 2>/dev/null || echo "")
        
        if [ -z "$S3_BUCKET" ]; then
          echo "âŒ S3 bucket name not found!"
          exit 1
        fi
        
        echo "ğŸ“¤ S3ì— ì—…ë¡œë“œ: $S3_BUCKET"
        
        # JAR íŒŒì¼ ì°¾ê¸°
        if [ -d "../inter-v" ]; then
          JAR_PATH="../inter-v/target"
        elif [ -d "../BE/inter-v" ]; then
          JAR_PATH="../BE/inter-v/target"
        else
          JAR_PATH="../target"
        fi
        
        JAR_FILE=$(find $JAR_PATH -name "*.jar" | head -1)
        
        if [ -n "$JAR_FILE" ]; then
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          
          # ë°±ì—… ë° ìµœì‹  ë²„ì „ ì—…ë¡œë“œ
          aws s3 cp "$JAR_FILE" "s3://$S3_BUCKET/releases/$TIMESTAMP/$APPLICATION_NAME.jar"
          aws s3 cp "$JAR_FILE" "s3://$S3_BUCKET/releases/latest/$APPLICATION_NAME.jar"
          
          echo "âœ… JAR ì—…ë¡œë“œ ì„±ê³µ"
          
          # ë°°í¬ ì •ë³´ ì €ì¥
          echo "{\"timestamp\":\"$TIMESTAMP\",\"commit\":\"$GITHUB_SHA\",\"branch\":\"$GITHUB_REF_NAME\"}" > deployment-info.json
          aws s3 cp deployment-info.json "s3://$S3_BUCKET/releases/latest/deployment-info.json"
          
          # Auto Scaling Group ì¸ìŠ¤í„´ìŠ¤ ê°±ì‹ 
          if aws autoscaling describe-auto-scaling-groups --auto-scaling-group-names interv-asg >/dev/null 2>&1; then
            echo "ğŸ”„ ì¸ìŠ¤í„´ìŠ¤ ê°±ì‹  ì‹œì‘..."
            
            REFRESH_ID=$(aws autoscaling start-instance-refresh \
              --auto-scaling-group-name interv-asg \
              --preferences MinHealthyPercentage=50,InstanceWarmup=300 \
              --query 'InstanceRefreshId' --output text)
            
            echo "ğŸ”„ Instance refresh ì‹œì‘ë¨: $REFRESH_ID"
            echo "â³ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ê³„ì† ì§„í–‰ë©ë‹ˆë‹¤..."
          else
            echo "âš ï¸ Auto Scaling Groupì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          fi
          
          echo ""
          echo "ğŸ‰ ë°°í¬ ì™„ë£Œ!"
          echo "ğŸŒ ì• í”Œë¦¬ì¼€ì´ì…˜: https://interv.swote.dev"
          echo "ğŸ¥ Health Check: https://interv.swote.dev/actuator/health"
          
        else
          echo "âŒ JAR íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          exit 1
        fi