name: Deploy InterV Application

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'README.md'
      - 'docs/**'

env:
  AWS_REGION: ap-northeast-2
  APPLICATION_NAME: interv

jobs:
  deploy-infrastructure:
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, '[deploy-infra]') || contains(github.event.head_commit.modified, 'infrastructure/')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: ~1.6.0
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Deploy Infrastructure
      env:
        TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
        TF_VAR_key_pair_name: ${{ secrets.EC2_KEY_PAIR_NAME }}
        TF_VAR_aws_region: ${{ env.AWS_REGION }}
        TF_VAR_app_name: ${{ env.APPLICATION_NAME }}
        TF_VAR_domain_name: "interv.swote.dev"
      run: |
        cd infrastructure/
        
        echo "ğŸ—ï¸ Initializing Terraform..."
        terraform init
        
        echo "ğŸ“‹ Planning infrastructure changes..."
        terraform plan -out=tfplan
        
        echo "ğŸš€ Applying infrastructure changes..."
        terraform apply tfplan
        
        echo "ğŸ“Š Saving Terraform outputs..."
        terraform output -json > terraform-outputs.json
        
        # S3 ë²„í‚· ì´ë¦„ì„ GitHub Environmentì— ì €ì¥ (ë‹¤ìŒ jobì—ì„œ ì‚¬ìš©)
        S3_BUCKET=$(terraform output -raw s3_bucket_name)
        echo "S3_BUCKET_NAME=$S3_BUCKET" >> $GITHUB_ENV
        echo "ğŸª£ S3 Bucket: $S3_BUCKET"
    
    outputs:
      s3_bucket_name: ${{ env.S3_BUCKET_NAME }}

  build-and-deploy:
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure]
    if: always() && !failure()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'corretto'
    
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: Build application
      run: |
        echo "ğŸ“¦ Building Spring Boot application..."
        
        # í”„ë¡œì íŠ¸ êµ¬ì¡°ì— ë”°ë¼ ë¹Œë“œ ë””ë ‰í† ë¦¬ ì°¾ê¸°
        if [ -d "inter-v" ]; then
          cd inter-v
          echo "Building in inter-v directory"
        elif [ -d "BE/inter-v" ]; then
          cd BE/inter-v
          echo "Building in BE/inter-v directory"
        else
          echo "âŒ Application directory not found!"
          exit 1
        fi
        
        mvn clean package -DskipTests
        
        # ë¹Œë“œ ê²°ê³¼ í™•ì¸
        JAR_FILE=$(find target -name "*.jar" | head -1)
        if [ -n "$JAR_FILE" ]; then
          echo "âœ… Build successful: $JAR_FILE"
        else
          echo "âŒ Build failed: No JAR file found"
          exit 1
        fi
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Get S3 bucket name
      id: get-bucket
      run: |
        # S3 ë²„í‚· ì´ë¦„ ê°€ì ¸ì˜¤ê¸° (Terraform output ë˜ëŠ” Secrets)
        if [ -n "${{ secrets.S3_BUCKET_NAME }}" ]; then
          S3_BUCKET="${{ secrets.S3_BUCKET_NAME }}"
        else
          # Terraform outputì—ì„œ ê°€ì ¸ì˜¤ê¸°
          cd infrastructure/
          S3_BUCKET=$(terraform output -raw s3_bucket_name 2>/dev/null || echo "")
        fi
        
        if [ -z "$S3_BUCKET" ]; then
          echo "âŒ S3 bucket name not found!"
          exit 1
        fi
        
        echo "S3_BUCKET=$S3_BUCKET" >> $GITHUB_OUTPUT
        echo "ğŸª£ Using S3 bucket: $S3_BUCKET"
    
    - name: Upload JAR to S3
      env:
        S3_BUCKET: ${{ steps.get-bucket.outputs.S3_BUCKET }}
      run: |
        echo "ğŸ“¤ Uploading application to S3..."
        
        # JAR íŒŒì¼ ì°¾ê¸°
        if [ -d "inter-v" ]; then
          JAR_PATH="inter-v/target"
        elif [ -d "BE/inter-v" ]; then
          JAR_PATH="BE/inter-v/target"
        else
          JAR_PATH="target"
        fi
        
        JAR_FILE=$(find $JAR_PATH -name "*.jar" | head -1)
        
        if [ -n "$JAR_FILE" ]; then
          # íƒ€ì„ìŠ¤íƒ¬í”„ì™€ í•¨ê»˜ ì—…ë¡œë“œ
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          
          # ë°±ì—…ìš© ì—…ë¡œë“œ
          aws s3 cp "$JAR_FILE" "s3://$S3_BUCKET/releases/$TIMESTAMP/$APPLICATION_NAME.jar"
          
          # ìµœì‹  ë²„ì „ ì—…ë¡œë“œ
          aws s3 cp "$JAR_FILE" "s3://$S3_BUCKET/releases/latest/$APPLICATION_NAME.jar"
          
          # ë°°í¬ ì •ë³´ ì—…ë¡œë“œ
          echo "{\"timestamp\":\"$TIMESTAMP\",\"commit\":\"$GITHUB_SHA\",\"branch\":\"$GITHUB_REF_NAME\",\"actor\":\"$GITHUB_ACTOR\"}" > deployment-info.json
          aws s3 cp deployment-info.json "s3://$S3_BUCKET/releases/latest/deployment-info.json"
          
          echo "âœ… JAR uploaded successfully: $JAR_FILE"
          echo "ğŸ“¦ Backup: s3://$S3_BUCKET/releases/$TIMESTAMP/"
          echo "ğŸ”„ Latest: s3://$S3_BUCKET/releases/latest/"
        else
          echo "âŒ JAR file not found in $JAR_PATH"
          exit 1
        fi
    
    - name: Trigger Auto Scaling Group refresh
      run: |
        echo "ğŸ”„ Triggering Auto Scaling Group refresh..."
        
        ASG_NAME="${APPLICATION_NAME}-asg"
        
        # í˜„ì¬ ì¸ìŠ¤í„´ìŠ¤ ìƒíƒœ í™•ì¸
        aws autoscaling describe-auto-scaling-groups \
          --auto-scaling-group-names $ASG_NAME \
          --query 'AutoScalingGroups[0].{Desired:DesiredCapacity,Running:Instances[?LifecycleState==`InService`]|length(@)}'
        
        # ì¸ìŠ¤í„´ìŠ¤ ìƒˆë¡œê³ ì¹¨ ì‹œì‘
        REFRESH_ID=$(aws autoscaling start-instance-refresh \
          --auto-scaling-group-name $ASG_NAME \
          --preferences MinHealthyPercentage=50,InstanceWarmup=300,CheckpointPercentages=50 \
          --query 'InstanceRefreshId' --output text)
        
        echo "ğŸ”„ Instance refresh started: $REFRESH_ID"
        echo "â³ Waiting for instance refresh to complete..."
        
        # ì™„ë£Œ ëŒ€ê¸°
        aws autoscaling wait instance-refresh-successful \
          --auto-scaling-group-name $ASG_NAME \
          --instance-refresh-ids $REFRESH_ID
        
        echo "âœ… Instance refresh completed successfully!"
    
    - name: Health check and verification
      run: |
        echo "ğŸ” Performing post-deployment health checks..."
        
        # ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ëŒ€ê¸°
        echo "â³ Waiting for application startup (60 seconds)..."
        sleep 60
        
        # Health check
        HEALTH_URL="https://interv.swote.dev/actuator/health"
        MAX_ATTEMPTS=10
        
        for i in $(seq 1 $MAX_ATTEMPTS); do
          echo "ğŸ¥ Health check attempt $i/$MAX_ATTEMPTS..."
          
          if curl -f -s "$HEALTH_URL" > /dev/null; then
            echo "âœ… Application is healthy!"
            
            # ìƒì„¸ ìƒíƒœ í™•ì¸
            echo "ğŸ“Š Application status:"
            curl -s "$HEALTH_URL" | jq . || curl -s "$HEALTH_URL"
            
            break
          else
            if [ $i -eq $MAX_ATTEMPTS ]; then
              echo "âŒ Health check failed after $MAX_ATTEMPTS attempts"
              echo "ğŸ” Checking ALB target health..."
              
              # ALB íƒ€ê²Ÿ ê·¸ë£¹ ìƒíƒœ í™•ì¸
              TARGET_GROUP_ARN=$(aws elbv2 describe-target-groups \
                --names "${APPLICATION_NAME}-tg" \
                --query 'TargetGroups[0].TargetGroupArn' --output text)
              
              aws elbv2 describe-target-health \
                --target-group-arn $TARGET_GROUP_ARN
              
              exit 1
            fi
            
            echo "â³ Waiting 30 seconds before retry..."
            sleep 30
          fi
        done
        
        echo ""
        echo "ğŸ‰ Deployment completed successfully!"
        echo "ğŸŒ Application URL: https://interv.swote.dev"
        echo "ğŸ¥ Health Check: https://interv.swote.dev/actuator/health"
        echo "ğŸ“Š Monitoring: AWS CloudWatch Console"