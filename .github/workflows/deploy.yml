name: Deploy InterV Application

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'README.md'
      - 'docs/**'

env:
  AWS_REGION: ap-northeast-2
  APPLICATION_NAME: interv

jobs:
  deploy-infrastructure:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: ~1.6.0
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Initialize Terraform
      run: |
        cd infrastructure/
        terraform init
    
    - name: Bulletproof Resource Import
      env:
        TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
        TF_VAR_key_pair_name: ${{ secrets.EC2_KEY_PAIR_NAME }}
        TF_VAR_aws_region: ${{ env.AWS_REGION }}
        TF_VAR_app_name: ${{ env.APPLICATION_NAME }}
        TF_VAR_domain_name: "interv.swote.dev"
      run: |
        cd infrastructure/
        
        echo "ğŸ›¡ï¸ ê°•ë ¥í•œ ë¦¬ì†ŒìŠ¤ Import ë° ì˜ˆì™¸ì²˜ë¦¬ ì‹œì‘..."
        echo ""
        
        # Import í•¨ìˆ˜ ì •ì˜ (ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰)
        bulletproof_import() {
            local resource_name="$1"
            local terraform_resource="$2"
            local aws_resource_id="$3"
            local check_command="$4"
            
            echo "ğŸ” $resource_name ì²˜ë¦¬ ì¤‘..."
            
            # ì´ë¯¸ Terraform stateì— ìˆëŠ”ì§€ í™•ì¸
            if terraform state show "$terraform_resource" >/dev/null 2>&1; then
                echo "  âœ… ì´ë¯¸ stateì— ì¡´ì¬: $resource_name"
                return 0
            fi
            
            # AWSì— ë¦¬ì†ŒìŠ¤ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
            if eval "$check_command" >/dev/null 2>&1; then
                echo "  ğŸ“¥ AWSì—ì„œ ë°œê²¬ - Import ì‹œë„: $aws_resource_id"
                
                if terraform import "$terraform_resource" "$aws_resource_id" 2>/dev/null; then
                    echo "  âœ… Import ì„±ê³µ: $resource_name"
                else
                    echo "  âš ï¸ Import ì‹¤íŒ¨í•˜ì§€ë§Œ ê³„ì† ì§„í–‰: $resource_name"
                fi
            else
                echo "  â„¹ï¸ AWSì— ì—†ìŒ - ìƒˆë¡œ ìƒì„±ë  ì˜ˆì •: $resource_name"
            fi
            echo ""
        }
        
        # í•µì‹¬ ë¦¬ì†ŒìŠ¤ë“¤ Import
        echo "ğŸ—ï¸ í•µì‹¬ ì¸í”„ë¼ ë¦¬ì†ŒìŠ¤:"
        
        bulletproof_import "DB Subnet Group" \
            "aws_db_subnet_group.main" \
            "interv-db-subnet-group" \
            "aws rds describe-db-subnet-groups --db-subnet-group-name interv-db-subnet-group"
        
        bulletproof_import "IAM Role" \
            "aws_iam_role.ec2_role" \
            "interv-ec2-role" \
            "aws iam get-role --role-name interv-ec2-role"
        
        bulletproof_import "IAM Role Policy" \
            "aws_iam_role_policy.ec2_policy" \
            "interv-ec2-role:interv-ec2-policy" \
            "aws iam get-role-policy --role-name interv-ec2-role --policy-name interv-ec2-policy"
        
        bulletproof_import "IAM Instance Profile" \
            "aws_iam_instance_profile.ec2_profile" \
            "interv-ec2-profile" \
            "aws iam get-instance-profile --instance-profile-name interv-ec2-profile"
        
        # Load Balancer ë¦¬ì†ŒìŠ¤ë“¤
        echo "âš–ï¸ Load Balancer ë¦¬ì†ŒìŠ¤:"
        
        ALB_ARN=$(aws elbv2 describe-load-balancers --names interv-alb --query 'LoadBalancers[0].LoadBalancerArn' --output text 2>/dev/null || echo "None")
        if [ "$ALB_ARN" != "None" ] && [ "$ALB_ARN" != "null" ]; then
            bulletproof_import "Application Load Balancer" \
                "aws_lb.main" \
                "$ALB_ARN" \
                "aws elbv2 describe-load-balancers --load-balancer-arns $ALB_ARN"
        fi
        
        TG_ARN=$(aws elbv2 describe-target-groups --names interv-tg --query 'TargetGroups[0].TargetGroupArn' --output text 2>/dev/null || echo "None")
        if [ "$TG_ARN" != "None" ] && [ "$TG_ARN" != "null" ]; then
            bulletproof_import "Target Group" \
                "aws_lb_target_group.app" \
                "$TG_ARN" \
                "aws elbv2 describe-target-groups --target-group-arns $TG_ARN"
        fi
        
        # Auto Scaling ë¦¬ì†ŒìŠ¤ë“¤
        echo "ğŸ”„ Auto Scaling ë¦¬ì†ŒìŠ¤:"
        
        bulletproof_import "Auto Scaling Group" \
            "aws_autoscaling_group.app" \
            "interv-asg" \
            "aws autoscaling describe-auto-scaling-groups --auto-scaling-group-names interv-asg"
        
        LT_ID=$(aws ec2 describe-launch-templates --launch-template-names interv-lt --query 'LaunchTemplates[0].LaunchTemplateId' --output text 2>/dev/null || echo "None")
        if [ "$LT_ID" != "None" ] && [ "$LT_ID" != "null" ]; then
            bulletproof_import "Launch Template" \
                "aws_launch_template.app" \
                "$LT_ID" \
                "aws ec2 describe-launch-templates --launch-template-ids $LT_ID"
        fi
        
        # ê¸°íƒ€ ë¦¬ì†ŒìŠ¤ë“¤
        echo "ğŸ“¦ ê¸°íƒ€ ë¦¬ì†ŒìŠ¤:"
        
        bulletproof_import "RDS Instance" \
            "aws_db_instance.main" \
            "interv-db" \
            "aws rds describe-db-instances --db-instance-identifier interv-db"
        
        # S3 Bucket
        S3_BUCKET=$(aws s3api list-buckets --query "Buckets[?starts_with(Name, 'interv-storage-')].Name" --output text 2>/dev/null || echo "")
        if [ -n "$S3_BUCKET" ] && [ "$S3_BUCKET" != "None" ]; then
            bulletproof_import "S3 Bucket" \
                "aws_s3_bucket.app_storage" \
                "$S3_BUCKET" \
                "aws s3api head-bucket --bucket $S3_BUCKET"
                
            bulletproof_import "S3 Bucket Versioning" \
                "aws_s3_bucket_versioning.app_storage" \
                "$S3_BUCKET" \
                "aws s3api get-bucket-versioning --bucket $S3_BUCKET"
        fi
        
        # Route53 íŠ¹ë³„ ì²˜ë¦¬
        echo "ğŸŒ Route53 ë ˆì½”ë“œ:"
        HOSTED_ZONE_ID=$(aws route53 list-hosted-zones --query "HostedZones[?Name=='swote.dev.'].Id" --output text | cut -d'/' -f3 2>/dev/null || echo "")
        if [ -n "$HOSTED_ZONE_ID" ]; then
            EXISTING_RECORD=$(aws route53 list-resource-record-sets \
                --hosted-zone-id "$HOSTED_ZONE_ID" \
                --query "ResourceRecordSets[?Name=='interv.swote.dev.' && Type=='A']" \
                --output json 2>/dev/null)
            
            if [ "$EXISTING_RECORD" != "[]" ] && [ -n "$EXISTING_RECORD" ]; then
                IMPORT_ID="${HOSTED_ZONE_ID}_interv.swote.dev_A"
                bulletproof_import "Route53 A Record" \
                    "aws_route53_record.main" \
                    "$IMPORT_ID" \
                    "echo true"
            fi
        fi
        
        echo "âœ… ê°•ë ¥í•œ Import ê³¼ì • ì™„ë£Œ!"
        echo ""
    
    - name: Smart Terraform Deployment
      env:
        TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
        TF_VAR_key_pair_name: ${{ secrets.EC2_KEY_PAIR_NAME }}
        TF_VAR_aws_region: ${{ env.AWS_REGION }}
        TF_VAR_app_name: ${{ env.APPLICATION_NAME }}
        TF_VAR_domain_name: "interv.swote.dev"
      run: |
        cd infrastructure/
        
        echo "ğŸ§  ìŠ¤ë§ˆíŠ¸ Terraform ë°°í¬ ì‹œì‘..."
        
        # Plan ì‹¤í–‰ (ì—¬ëŸ¬ ë²ˆ ì‹œë„)
        PLAN_SUCCESS=false
        for attempt in 1 2 3; do
            echo "ğŸ“‹ Plan ì‹œë„ $attempt/3..."
            
            if terraform plan -out=tfplan 2>/dev/null; then
                echo "âœ… Plan ì„±ê³µ!"
                PLAN_SUCCESS=true
                break
            else
                echo "âš ï¸ Plan ì‹¤íŒ¨ - $attemptë²ˆì§¸ ì‹œë„"
                
                if [ $attempt -lt 3 ]; then
                    echo "ğŸ”„ 30ì´ˆ ëŒ€ê¸° í›„ ì¬ì‹œë„..."
                    sleep 30
                    
                    # Terraform ìƒíƒœ ìƒˆë¡œê³ ì¹¨
                    terraform refresh -auto-approve 2>/dev/null || true
                fi
            fi
        done
        
        if [ "$PLAN_SUCCESS" = false ]; then
            echo "âŒ 3ë²ˆì˜ Plan ì‹œë„ ëª¨ë‘ ì‹¤íŒ¨"
            echo "ğŸ” Plan ìƒì„¸ ë¡œê·¸:"
            terraform plan 2>&1 || true
            exit 1
        fi
        
        # Apply ì‹¤í–‰
        echo ""
        echo "ğŸš€ Infrastructure ë°°í¬ ì‹¤í–‰..."
        
        APPLY_SUCCESS=false
        for attempt in 1 2; do
            echo "ğŸ”§ Apply ì‹œë„ $attempt/2..."
            
            if terraform apply tfplan; then
                echo "âœ… Apply ì„±ê³µ!"
                APPLY_SUCCESS=true
                break
            else
                echo "âš ï¸ Apply ì‹¤íŒ¨ - $attemptë²ˆì§¸ ì‹œë„"
                
                if [ $attempt -lt 2 ]; then
                    echo "ğŸ”„ ìƒˆë¡œìš´ Plan ìƒì„± í›„ ì¬ì‹œë„..."
                    terraform plan -out=tfplan
                fi
            fi
        done
        
        if [ "$APPLY_SUCCESS" = false ]; then
            echo "âŒ Apply ì‹¤íŒ¨"
            exit 1
        fi
        
        # Output ìˆ˜ì§‘
        echo "ğŸ“Š Terraform Outputs ìˆ˜ì§‘..."
        terraform output -json > terraform-outputs.json || true
        
        S3_BUCKET=$(terraform output -raw s3_bucket_name 2>/dev/null || echo "")
        if [ -n "$S3_BUCKET" ]; then
            echo "S3_BUCKET_NAME=$S3_BUCKET" >> $GITHUB_ENV
            echo "ğŸª£ S3 Bucket: $S3_BUCKET"
        fi
        
        echo ""
        echo "ğŸ‰ Infrastructure ë°°í¬ ì™„ë£Œ!"
    
    outputs:
      s3_bucket_name: ${{ env.S3_BUCKET_NAME }}

  build-and-deploy:
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure]
    if: always() && !failure()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'corretto'
    
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: Build application
      run: |
        echo "ğŸ“¦ Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ..."
        
        if [ -d "inter-v" ]; then
          cd inter-v
          echo "Building in inter-v directory"
        elif [ -d "BE/inter-v" ]; then
          cd BE/inter-v
          echo "Building in BE/inter-v directory"
        else
          echo "âŒ Application directory not found!"
          exit 1
        fi
        
        mvn clean package -DskipTests
        
        JAR_FILE=$(find target -name "*.jar" | head -1)
        if [ -n "$JAR_FILE" ]; then
          echo "âœ… ë¹Œë“œ ì„±ê³µ: $JAR_FILE"
        else
          echo "âŒ ë¹Œë“œ ì‹¤íŒ¨: JAR íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          exit 1
        fi
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Deploy Application
      run: |
        echo "ğŸš€ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬..."
        
        cd infrastructure/
        terraform init
        S3_BUCKET=$(terraform output -raw s3_bucket_name 2>/dev/null || echo "")
        
        if [ -z "$S3_BUCKET" ]; then
          echo "âŒ S3 bucket name not found!"
          exit 1
        fi
        
        # JAR íŒŒì¼ ì—…ë¡œë“œ
        if [ -d "../inter-v" ]; then
          JAR_PATH="../inter-v/target"
        elif [ -d "../BE/inter-v" ]; then
          JAR_PATH="../BE/inter-v/target"
        else
          JAR_PATH="../target"
        fi
        
        JAR_FILE=$(find $JAR_PATH -name "*.jar" | head -1)
        
        if [ -n "$JAR_FILE" ]; then
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          
          aws s3 cp "$JAR_FILE" "s3://$S3_BUCKET/releases/$TIMESTAMP/$APPLICATION_NAME.jar"
          aws s3 cp "$JAR_FILE" "s3://$S3_BUCKET/releases/latest/$APPLICATION_NAME.jar"
          
          echo "âœ… JAR ì—…ë¡œë“œ ì„±ê³µ"
          
          # Auto Scaling Group ì¸ìŠ¤í„´ìŠ¤ ê°±ì‹ 
          if aws autoscaling describe-auto-scaling-groups --auto-scaling-group-names interv-asg >/dev/null 2>&1; then
            echo "ğŸ”„ ì¸ìŠ¤í„´ìŠ¤ ê°±ì‹ ..."
            aws autoscaling start-instance-refresh \
              --auto-scaling-group-name interv-asg \
              --preferences MinHealthyPercentage=50,InstanceWarmup=300 \
              --query 'InstanceRefreshId' --output text
            echo "âœ… ì¸ìŠ¤í„´ìŠ¤ ê°±ì‹  ì‹œì‘ë¨"
          fi
          
          echo ""
          echo "ğŸ‰ ë°°í¬ ì™„ë£Œ!"
          echo "ğŸŒ Application: https://interv.swote.dev"
          echo "ğŸ¥ Health Check: https://interv.swote.dev/actuator/health"
          
        else
          echo "âŒ JAR íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          exit 1
        fi